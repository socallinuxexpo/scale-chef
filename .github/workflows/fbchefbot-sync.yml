name: FBChefSync Bot - Upstream Sync

on:
  workflow_dispatch:  # allow manual trigger from UI
  pull_request:  # Test PR changes in PR context - REQUIRES branch-bsed PRs
    types: [opened, synchronize]
    branches:
      - main
  pull_request_target:  # Run on main when PR closes (has secrets)
    types: [closed]
    branches:
      - main
  issues:
    types: [closed]
  #schedule:
  #  - cron: '0 6 * * *'  # daily at 06:00 UTC, adjust as needed

# Ensure only one bot run executes at a time across all triggers
concurrency:
  group: chef-sync-bot
  cancel-in-progress: false  # Queue runs instead of canceling

jobs:
  sync:
    name: Run daily sync
    uses: jaymzh/chef-cookbooks/.github/workflows/reusable-fbchefsync-bot.yml
    with:
      upstream_remote_name: 'fb-upstream'
      # For pull_request: use PR head branch, otherwise use main
      base_branch: ${{ github.event_name == 'pull_request' && github.head_ref || 'main' }}
      python_version: '3.11'
      # Dry-run only for pull_request (testing PR changes)
      dry_run: ${{ github.event_name == 'pull_request' }}
    secrets:
      gh_token: ${{ secrets.GITHUB_TOKEN }}
