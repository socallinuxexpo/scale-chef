#!/bin/sh
# Generated by chef

LOGROTATE="/usr/sbin/logrotate"
IONICE="/usr/bin/ionice"
NICE="/usr/bin/nice"
FLOCK_FILE="/var/run/logrotate.flock"
PATH="/usr/bin:/usr/sbin"

[ -x ${IONICE} ] && LOGROTATE="${IONICE} -c3 ${LOGROTATE}"
[ -x ${NICE} ] && LOGROTATE="${NICE} -n 19 ${LOGROTATE}"

# Implement a flock to make sure our logrotate processes are not running
# on top of each other! t3385026
(
    flock -n 200
    if [ $? != 0 ]; then
        logger -t logrotate "ERROR: logrotate already running"
        exit
    fi

<% if node['fb_logrotate']['debug_log'] %>
    date >> /tmp/logrotate.debug.log
    echo "Starting logrotate run." >> /tmp/logrotate.debug.log
<%   output = '-v >>/tmp/logrotate.debug.log' %>
<% else %>
<%   output = '>/dev/null' -%>
<% end %>
    ${LOGROTATE} /etc/logrotate.conf <%= output %> 2>&1 200>/dev/null
    EXITVALUE=$?
    if [ $EXITVALUE != 0 ]; then
        logger -t logrotate "ALERT exited abnormally with [$EXITVALUE]"
    fi
    exit 0
) 200> ${FLOCK_FILE}
